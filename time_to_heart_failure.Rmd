---
title: "Time to heart failure survival analysis"
author: "Christophe Mpaga, Ahmed Oulad Amara, Adrien Parruitte"
output: 
  
  pdf_document: 
    toc: yes
---

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Context
Heart failure is a chronic condition where the heart is unable to effectively pump enough blood to meet the body's needs. It occurs when the heart muscle becomes weakened or damaged, leading to symptoms like shortness of breath, fatigue, and fluid retention. Heart failures happen from a variety of reason such as coronary disease, diabetes, obesity etc. In this study we will analyse time heart failure and investigate  the importance of various factors on the survival of patient having heart failure. The event we analyse is then the death of the patient.

```{r libraries, message=FALSE,warning=FALSE}
library(survival)
library(tidyverse)
library(survminer)
library(broom)
```
# Introduction

The individuals of the data were patients admitted to Institute of Cardiology and Allied hospital Faisalabad-Pakistan during April-December (2015). From the 299 patients of the dataset, 105 are women and are 194 men. They are between 40 and 95 years. All have left ventricular systolic dysfunction, belonging to  New York Heart Association (NYHA) class III and IV. Class III means patients have marked limitations of physical activity. They are comfortable at rest but experience symptoms with less than ordinary physical activity. Class IV means patients are unable to carry out any physical activity without discomfort. They may have symptoms even at rest and are often bedridden. 
From the 299 patients of the dataset, 105 are women and are 194 men. They are between 40 and 95 years.  

# Methods 
## data acquisition preparation and investigation.    
### data dictionary  
Data originate from the study of Ahmad et al. 2017 ^[Ahmad, Tanvir; Munir, Assia; Bhatti, Sajjad Haider; Aftab, Muhammad; Ali Raza, Muhammad (2017). DATA_MINIMAL.. PLOS ONE. Dataset. https://doi.org/10.1371/journal.pone.0181001.s001]. 
The dataset has 13 features: Age, Anemia, High Blood Pressure, Creatinine phosphokinase, Diabetes, Ejection Fraction, Sex, Platelets, Serum Creatinine, Serum Sodium, Smoking, Time and Death Event. 
We explain some of the non-evident features:  
  - anemia : lower than normal haemoglobin concentration in blood
  - Creatinine phosphokinase : an enzyme notably found in the heart. Can leak in the blood in case of heart damage. 
  - serum creatinine : a waste formed by the functioning of muscle. It is present in the blood and eliminated by the kidney through urine. As it is a serum creatinine the amount is not error induced by the taking of supplement creatine   
  - ejection fraction : percentage of blood pump out of the left ventricle with each contraction. If the EF is less than 40%, it indicates an heart failure or cardiomyopathy. 
  - platelets : the normal amount of platelets ranges between 150,000 to 450,000 per $\mu$L of blood.   
  - serum sodium : sodium amount in blood is a well known indicator of heart failure.   Is normal value ranges between 135-145 milli equivalents per liter.
The presence of time and death event make this dataset perfectly adapted for a survival analysis.The unit of time is day. As all the patients didn't die, the dataset has right censored data.   

```{r  load data}
data <- read_csv('data/heart_failure_clinical_records_dataset.csv')
```

```{r}
head(data,3)
```

```{r}
#summary(data)
```

```{r}
data$sex <- factor(data$sex, labels= c("female", "male"))
data$anaemia <- factor(data$anaemia)
data$diabetes <- factor(data$diabetes)
data$high_blood_pressure <- factor(data$high_blood_pressure)
data$smoking <- factor(data$smoking)
```

```{r}
# Define the breakpoints for the three levels
breakpoints <- c(-Inf, 30, 45, Inf)
# Divide EF into three levels
data$EF_levels <- cut(data$ejection_fraction, breaks = breakpoints, labels = c("EF <= 30", "30 < EF <= 45", "EF > 45"))

```


## overall Kaplan-Meyer estimator
We estimate the survival probability with the Kaplan-meier estimator.
```{r}
fit.KM <- survfit(Surv(time,DEATH_EVENT) ~ 1, data = data)
fit.KM
```


96 (32%) patients died due to the Cardiovascular Heart Disease (CHD). The median, 0.95LCL and 0.95UCl are NA because too many data are right censored. We need to go deeper in the analysis. 
```{r}
ggsurvplot(fit.KM, 
           #fun = "event",
          # conf.int=TRUE, 
           #pval.method = TRUE,
           #pval=TRUE, 
           #risk.table=TRUE, 
           break.time.by = 50, 
           #palette=c("dodgerblue2"),
           title="Kaplan-Meier Curve for Heart Failure Survival",
           xlab = "Days",
           #risk.table.height=.30, 
          data=data)  

```
As the EF level and the high tension are the directly heart related covariates, we use them for the Kaplan Meier survival estimate  

## univariate analysis : group comparison 
### Ejection fraction (EF)

```{r}
fit.EF <- survfit(Surv(time,DEATH_EVENT) ~ EF_levels, data = data)

# conditional plot 
if (surv_pvalue(fit.EF,data)$pval <= 0.05){
ggsurvplot(fit.EF, 
            #fun = "event",
           #conf.int=TRUE,
           surv.median.line = "hv",
           break.time.by = 25, 
           pval=TRUE,
           title="Survival time difference in  EF levels ",  
           xlab = "Days",
          # risk.table.height=.30,
           data=data) } else {
cat("p-value = ",surv_pvalue(fit.EF,data)$pval ,". There is no difference of EF in time to heart failure")
           }
```
```{r}
# summary(km)$table["median"]
fit.EF
```

Since the p-value is less than 0.05 we reject the null hypothesis, this means  there is a statistically significant difference in survival between the three groups.  

### high blood pressure (hbp) 
```{r}

fit.hbp <- survfit(Surv(time,DEATH_EVENT) ~ high_blood_pressure, data = data)
if (surv_pvalue(fit.hbp,data)$pval <= 0.05) {
ggsurvplot(fit.hbp, 
           #surv.median.line = "hv",
          #fun = "event",
          # conf.int=TRUE,
           pval=TRUE,
           break.time.by = 50, 
           title="Survival time difference in high blood pressure ", 
           xlab = "Days",
           risk.table = T,
           risk.table.height=.30,
           data=data)} else {
            cat("No difference in survival time in hbp")
          }
```
`r surv_pvalue(fit.hbp,data)$pval`, there is a group difference in survival time wrt/ high blood pressure in time to heart failure.  

 
### Sex  
```{r}
fit.KM3 <- survfit(Surv(time,DEATH_EVENT) ~ sex, data = data)
if (surv_pvalue(fit.KM3,data = data)$pval <= 0.05) {
ggsurvplot(fit.KM3, 
            #fun = "event",
           #conf.int=TRUE, 
           pval=TRUE,
           break.time.by = 50, 
           title="survival time difference in Sex ", 
           xlab = "Days",
           #risk.table.height=.30, 
           data=data)} else {
  cat("p-value = ",surv_pvalue(fit.KM3,data = data)$pval,". No statistical difference, i.e. no difference of time to heart failure in sex")
}
```


```{r,eval = F}
plot(fit.KM, fun = "F")
```

From survival curves of male and female and using the long rank test we can concluded that the sex has no significant impact  

### Smoking.  
```{r}
smocking_fit <- survfit(Surv(time, DEATH_EVENT) ~ smoking , data = data)
if (surv_pvalue(smocking_fit,data)$pval >= 0.05) {
cat("p-value = ",surv_pvalue(smocking_fit,data)$pval,"There no difference in survival time in Smoking.")
}
```



### diabetes  
```{r} 
diabetes_fit <- survfit(Surv(time, DEATH_EVENT) ~ diabetes , data = data)
if(surv_pvalue(diabetes_fit,data)$pval <= 0.05) {

ggsurvplot(diabetes_fit, 
            #fun = "event",
           #conf.int=TRUE, 
           pval=TRUE, 
           #risk.table=TRUE, 
           legend.title="diabetes",  
           palette=c("dodgerblue2", "orchid2"),
           title="Kaplan-Meier Curve for Heart Failure Survival", 
           #risk.table.height=.28,
           data=data)
} else {
  cat("p-value = ",surv_pvalue(diabetes_fit,data)$pval, "There is no difference in survival time in diabetes")
}
```
### anaemia  
```{r}
anaemia_fit <- survfit(Surv(time, DEATH_EVENT) ~ anaemia , data = data)
cat("p-value = ",round(surv_pvalue(anaemia_fit,data)$pval,2),
    "there is no difference in survival time")
```

```{r,eval=FALSE}
ggsurvplot(anaemia_fit, 
           conf.int=TRUE,
           pval=TRUE, 
           risk.table=TRUE, 
           legend.title="anaemia",  
           palette=c("dodgerblue2", "orchid2"),
           title="Kaplan-Meier Curve for Heart Failure Survival", 
           risk.table.height=.28, data=data)
```

### age  
age is continuous variable we need first to discretize it, over 60 because 60 is median 
```{r}
d_age60 <-
  data |>
  mutate(age60 = factor(age <= 60,
                      labels = c(" <= 60 ", " > 60 ")))

table(d_age60$age60)

data$over60 = d_age60$age60
```

### effect of age over 60  
```{r}
age.fit <- survfit(Surv(time, DEATH_EVENT) ~ over60 , data = data)
if (surv_pvalue(age.fit,data)$pval <= 0.5) {
  ggsurvplot(age.fit, 
          break.time.by = 50,
          pval=TRUE, 
          risk.table=TRUE, 
          xlab = "Days",
          legend.title="over60",  
          palette=c("dodgerblue2", "orchid2"),
           title="Kaplan-Meier Curve for Heart Failure Survival", 
           risk.table.height=.28, data=data)
}else {
  cat(" p-value = ",round(surv_pvalue(age.fit,data)$pval,2), "There is no difference in survival time in age over 60")
}
```


## bivariates analysis  
### additive effect of age and anaemia. 
```{r}
age_anaemia_fit <- survfit(Surv(time, DEATH_EVENT) ~ over60 + anaemia , data = data)
if (surv_pvalue(age_anaemia_fit,data)$pval <= 0.05){
  
ggsurv <- ggsurvplot(age_anaemaia_fit, 
                     conf.int = TRUE,data=data,
                     ggtheme = theme_bw())

ggsurv$plot +theme_bw() + 
  theme (legend.position = "right") } else {
    cat("p-value =",round(surv_pvalue(age_anaemia_fit,data)$pval,3),
        "There is no difference in survival time with respect to age and anaemia" )
  }
```

### additive effect of high_blood_pressure and anaemia. 
```{r}
age_anaemia_fit <- survfit(Surv(time, DEATH_EVENT) ~ high_blood_pressure + anaemia , data = data)
if(surv_pvalue(age_anaemia_fit,data)$pval <= 0.05){
        ggsurvplot(sfit, 
           #fun = "event", 
           pval = TRUE , data = data, 
           legend.title="",
           title="additive effect of anaemia and high blood pressure"
           )
} else {
  cat("p-value = ",surv_pvalue(age_anaemia_fit,data)$pval,"There is no additive effect of hbp and anaemia")
}
```

## Multivariates analysis : Cox Proportional Hazards Model.  
### effect of EF + hbp + age 
```{r}
fit_cph <- coxph(Surv(time, DEATH_EVENT) ~., 
                 data = data)
summary(fit_cph) %>% 
  coefficients() %>% 
  as.data.frame() %>% 
  filter(`Pr(>|z|)` <= 0.05) %>% 
  select(contains(c("coef","Pr"))) -> sum
sum
```

Patients presenting `high_blood_pressure`, `EF_levels30 < EF <= 45`, `EF_levelsEF > 45`, `age > 60`, `serum_creatinine`, `serum_sodium`  are more likely to experience heart failure and die. Moreover, presenting a `high_blood_pressure` increases the risk of heart failure by a hazard rate of 1.53, holding other covariates fixed, while, `EF_levels30 < EF <= 45`, `EF_levelsEF > 45`, `age > 60`, `serum_creatinine` and  `serum_sodium`  increases the risk of dying from heart failure with hazard rate magnitude greater or almost equal  to 1. 

# Results   
In this application, we were to analyze time to heart failure in this cohort, the event being death. We have found that, there is no median time to death. Our results show that there is an effect of high blood pressure , EF and ageing,but surprisingly no effect of Smocking, nor diabetes or anaemia. There is a group difference in survival time in  `EF` and `high blood pressure`. Half of subject having  `EF` less than 30 , are expected to die after  almost 175 days. An additive model with covariates,  `high_blood_pressure1`, `EF_levels30 < EF <= 45`, `EF_levelsEF > 45` , `age > 60` , `serum_creatinine` and `serum_sodium` shows that, patients presenting a profile with theses covariates are more likely to experience heart failure and die. Also, There is a  noticeable  effect of ageing `(age > 60)`. 

# Discussion 

We aim at analyzing time to heart failure.We have found that, there is an effect of high blood pressure , EF , serum_creatinine, serum_sodium and ageing, but surprisingly no effect of Smocking, nor diabetes or anaemia. `(why : to document)`

# Conclusions   
Following our results, we can conclude that ageing, Ejection fraction, serum_creatinine , serum_sodium and high blood pressure influence time to heart failure and the occurence of CHD as well as ageing. Overall, above half of these patients died early of heart failure. Though there was a high risk of death in this cohort.. 

# References   

Ahmad T, Munir A, Bhatti SH, Aftab M, Raza MA (2017) Survival analysis of heart failure patients: A case study. PLoS ONE 12(7): e0181001. https://doi.org/10.1371/journal.pone.0181001

